// require("dotenv").config();
// const axios = require("axios");

// module.exports = async function handleWooOrder(order, wooProductMap) {
//   // Ensure order exists and is structured correctly
//   if (!order || !order.id || !order.line_items) {
//     console.error("âŒ Invalid order structure", order);
//     return;
//   }

//   // Iterate through each line item (product) in the WooCommerce order
//   for (const item of order.line_items) {
//     const quantity = item.quantity; // The quantity of the product ordered
//     const meta = item.meta_data || [];  // Meta data associated with the item

//     // Find the shopify_product_id from WooCommerce metadata
//     const shopifyMeta = meta.find(m => m.key === "shopify_product_id");
//     const shopifyProductId = shopifyMeta ? shopifyMeta.value : null;

//     if (!shopifyProductId) {
//       console.warn(`âš ï¸ No Shopify Product ID found for item: ${item.name}`);
//       continue; // Skip to the next item if no Shopify Product ID
//     }

//     try {
//       // Step 1: Fetch the corresponding Shopify product's variant information
//       const variantRes = await axios.get(
//         `https://${process.env.SHOPIFY_STORE_URL}/admin/api/2024-01/products/${shopifyProductId}/variants.json`,
//         {
//           headers: {
//             "X-Shopify-Access-Token": process.env.SHOPIFY_ACCESS_TOKEN,
//             "Content-Type": "application/json"
//           }
//         }
//       );

//       const variants = variantRes.data.variants;
//       if (!variants || variants.length === 0) {
//         console.error("âŒ No variants found for this product.");
//         continue;  // Skip if no variants are found
//       }

//       const inventoryItemId = variants[0].inventory_item_id;
//       console.log(`âž¡ï¸ Found Inventory Item ID: ${inventoryItemId}`);

//       // Step 2: Adjust inventory levels in Shopify
//       const adjustEndpoint = `https://${process.env.SHOPIFY_STORE_URL}/admin/api/2024-01/inventory_levels/adjust.json`;
//       const payload = {
//         location_id: process.env.SHOPIFY_LOCATION_ID,  // Your Shopify location ID
//         inventory_item_id: inventoryItemId,
//         available_adjustment: -quantity  // Reduce stock based on order quantity
//       };

//       // Make the API call to adjust the inventory
//       await axios.post(adjustEndpoint, payload, {
//         headers: {
//           "X-Shopify-Access-Token": process.env.SHOPIFY_ACCESS_TOKEN,
//           "Content-Type": "application/json"
//         }
//       });

//       console.log(`âœ… Inventory updated for product ${shopifyProductId} | Adjusted  by -${quantity}`);
//     } catch (err) {
//       console.error("âŒ Error processing product:", err.response?.data || err.message);
//     }
//   }
  
//   console.log(`âœ… WooCommerce Order Processed: ${order.id}`);
// };


/// -------------------------------------------------------------------------------------------------------------------------

// // woo-to-shopify.js
// // Handles WooCommerce â†’ Shopify order webhooks by adjusting Shopify inventory
// require("dotenv").config();
// const axios = require("axios");
// const { lastUpdatedStock } = require("./sync-cache");

// module.exports = async function handleWooOrder(order) {
//   if (!order || !order.id || !Array.isArray(order.line_items)) {
//     console.error("âŒ Invalid Woo order payload");
//     return;
//   }

//   for (const item of order.line_items) {
//     const qty = item.quantity;
//     const meta = item.meta_data || [];
//     const shopifyMeta = meta.find(m => m.key === "shopify_product_id");
//     const productId = shopifyMeta ? String(shopifyMeta.value) : null;
//     if (!productId) {
//       console.warn(`âš ï¸ No Shopify ID for Woo item ${item.name}`);
//       continue;
//     }

//     try {
//       // Get variant to find inventory_item_id
//       const varRes = await axios.get(
//         `https://${process.env.SHOPIFY_STORE_DOMAIN}/admin/api/2024-01/products/${productId}/variants.json`,
//         { headers: { "X-Shopify-Access-Token": process.env.SHOPIFY_ADMIN_API_ACCESS_TOKEN } }
//       );
//       const variant = varRes.data.variants?.[0];
//       if (!variant) {
//         console.error(`âŒ No Shopify variant for product ${productId}`);
//         continue;
//       }

//       const invItemId = variant.inventory_item_id;
//       const currentQty = variant.inventory_quantity || 0;
//       const expectedQty = currentQty - qty;
//       lastUpdatedStock.set(productId, expectedQty);

//       // Adjust inventory
//       await axios.post(
//         `https://${process.env.SHOPIFY_STORE_DOMAIN}/admin/api/2024-01/inventory_levels/adjust.json`,
//         {
//           location_id: process.env.SHOPIFY_LOCATION_ID,
//           inventory_item_id: invItemId,
//           available_adjustment: -qty
//         },
//         { headers: { "X-Shopify-Access-Token": process.env.SHOPIFY_ADMIN_API_ACCESS_TOKEN } }
//       );

//       console.log(`âœ… Shopify stock adjusted for ${productId} by -${qty}`);
//     } catch (err) {
//       console.error("âŒ Error syncing to Shopify:", err.response?.data || err.message);
//     }
//   }

//   console.log(`âœ… Processed Woo Order ${order.id}`);
// };

//-----------------ABOVE CODE IS WORKING FOR MANUAL UPATE -----------------------


// // woo-to-shopify.js
// // Exports two handlers: ordersâ†’Shopify and inventory-levelsâ†’WooCommerce

// require("dotenv").config();
// const axios = require("axios");
// const { updateWooCommerceInventory } = require("./woocommerce-api");
// const { lastUpdatedStock } = require("./sync-cache");

// /**
//  * 1ï¸âƒ£ WooCommerce order â†’ Shopify inventory adjust
//  */
// module.exports.handleWooOrder = async function(order) {
//   if (!order?.id || !Array.isArray(order.line_items)) {
//     console.error("âŒ Invalid Woo order payload");
//     return;
//   }

//   for (const item of order.line_items) {
//     const qty = item.quantity;
//     const meta = item.meta_data || [];
//     // const shopifyMeta = meta.find(m => m.key === "shopify_product_id");
//     // const productId = shopifyMeta?.value && String(shopifyMeta.value);

//     const shopifyMeta = meta.find(m => m.key === "shopify_product_id");
//     const productId   = shopifyMeta
//     ? String(shopifyMeta.value).trim()
//     : null;

//     if (!productId) {
//       console.warn(`âš ï¸ No Shopify ID for Woo item ${item.name}`);
//       continue;
//     }

//     try {
//       // fetch variant â†’ inventory_item_id + current qty
//       const { data } = await axios.get(
//         `https://${process.env.SHOPIFY_STORE_DOMAIN}/admin/api/2024-01/products/${productId}/variants.json`,
//         { headers: { "X-Shopify-Access-Token": process.env.SHOPIFY_ADMIN_API_ACCESS_TOKEN } }
//       );
//       const variant = data.variants?.[0];
//       if (!variant) {
//         console.error(`âŒ No Shopify variant for product ${productId}`);
//         continue;
//       }

//       const invItemId = variant.inventory_item_id;
//       const curr = variant.inventory_quantity ?? 0;
//       const expected = curr - qty;
//       // pre-seed cache so our own adjust doesnâ€™t loop back
//       lastUpdatedStock.set(productId, expected);

//       // call inventory_levels/adjust
//       await axios.post(
//         `https://${process.env.SHOPIFY_STORE_DOMAIN}/admin/api/2024-01/inventory_levels/adjust.json`,
//         {
//           location_id: process.env.SHOPIFY_LOCATION_ID,
//           inventory_item_id: invItemId,
//           available_adjustment: -qty
//         },
//         { headers: { "X-Shopify-Access-Token": process.env.SHOPIFY_ADMIN_API_ACCESS_TOKEN } }
//       );

//       console.log(`âœ… Shopify stock adjusted (${productId}) by -${qty}`);
//     } catch (err) {
//       console.error("âŒ Error syncing to Shopify:", err.response?.data || err.message);
//     }
//   }

//   console.log(`âœ… Woo order processed: ${order.id}`);
// };

// /**
//  * 2ï¸âƒ£ Inventory Level webhook â†’ WooCommerce stock update
//  */
// module.exports.handleShopifyInventoryWebhook = async function(inventory_item_id, available) {
//   try {
//     // find variant â†’ get variant ID
//     const url = `https://${process.env.SHOPIFY_STORE_DOMAIN}/admin/api/2024-01/variants.json`;
//     const { data } = await axios.get(url, {
//       headers: { "X-Shopify-Access-Token": process.env.SHOPIFY_ADMIN_API_ACCESS_TOKEN },
//       params: { inventory_item_ids: inventory_item_id }
//     });

//     const variant = data.variants?.[0];
//     if (!variant) {
//       console.error("âŒ No Shopify variant for inventory_item_id", inventory_item_id);
//       return;
//     }

//     const variantId = variant.id;
//     console.log(`ðŸ”„ Shopify variant ${variantId} â†’ available ${available}`);

//     // forward to WooCommerce
//     await updateWooCommerceInventory(variantId, available);
//   } catch (err) {
//     console.error("âŒ Failed to handle inventory-level webhook:", err.message);
//   }
// };


/// ----  ABOVE CODE IS CALLING MANY TIMES AFTER WOO UPDATE ---------------------------


// woo-to-shopify.js
// Exports two handlers: ordersâ†’Shopify and inventory-levelsâ†’WooCommerce

require("dotenv").config();
const axios = require("axios");
const { updateWooCommerceInventory } = require("./woocommerce-api");
const { lastUpdatedStock } = require("./sync-cache");

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Internal caches for dedupe & staleness checks (Inventory webhooks only)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const seenInventoryWebhooks = new Set();      
// Map of inventory_item_id â†’ { available: number, timestamp: ISOString }
const lastInventoryUpdate    = new Map();

// Helper to fetch Shopify product ID from inventory_item_id
async function getShopifyProductIdFromInventoryItem(inventory_item_id) {
  const url = `https://${process.env.SHOPIFY_STORE_DOMAIN}/admin/api/2024-01/variants.json`;
  const resp = await axios.get(url, {
    headers: { "X-Shopify-Access-Token": process.env.SHOPIFY_ADMIN_API_ACCESS_TOKEN },
    params: { inventory_item_ids: inventory_item_id }
  });
  const variant = resp.data.variants?.[0];
  if (!variant) return null;
  return variant.product_id;  // NOTE: we switch to product_id for Woo matching
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 1ï¸âƒ£ WooCommerce order â†’ Shopify inventory adjust
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
module.exports.handleWooOrder = async function(order) {
  if (!order?.id || !Array.isArray(order.line_items)) {
    console.error("âŒ Invalid Woo order payload");
    return;
  }

  for (const item of order.line_items) {
    const qty = item.quantity;
    const meta = item.meta_data || [];
    const shopifyMeta = meta.find(m => m.key === "shopify_product_id");
    const productId   = shopifyMeta?.value && String(shopifyMeta.value).trim();
    if (!productId) {
      console.warn(`âš ï¸ No Shopify ID for Woo item ${item.name}`);
      continue;
    }

    try {
      // fetch variant â†’ inventory_item_id + current qty
      const { data } = await axios.get(
        `https://${process.env.SHOPIFY_STORE_DOMAIN}/admin/api/2024-01/products/${productId}/variants.json`,
        { headers: { "X-Shopify-Access-Token": process.env.SHOPIFY_ADMIN_API_ACCESS_TOKEN } }
      );
      const variant = data.variants?.[0];
      if (!variant) {
        console.error(`âŒ No Shopify variant for product ${productId}`);
        continue;
      }

      const invItemId = variant.inventory_item_id;
      const curr      = variant.inventory_quantity ?? 0;
      const expected  = curr - qty;

      // pre-seed cache so our own adjust doesnâ€™t loop back
      lastUpdatedStock.set(productId, expected);

      // call inventory_levels/adjust
      await axios.post(
        `https://${process.env.SHOPIFY_STORE_DOMAIN}/admin/api/2024-01/inventory_levels/adjust.json`,
        {
          location_id:           process.env.SHOPIFY_LOCATION_ID,
          inventory_item_id:     invItemId,
          available_adjustment: -qty
        },
        { headers: { "X-Shopify-Access-Token": process.env.SHOPIFY_ADMIN_API_ACCESS_TOKEN } }
      );

      console.log(`âœ… Shopify stock adjusted (${productId}) by -${qty}`);
    } catch (err) {
      console.error("âŒ Error syncing to Shopify:", err.response?.data || err.message);
    }
  }

  console.log(`âœ… Woo order processed: ${order.id}`);
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// 2ï¸âƒ£ Inventory Level webhook â†’ WooCommerce stock update
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Note: index.js must call this as
//    handleShopifyInventoryWebhook(inventory_item_id, available, updated_at)
module.exports.handleShopifyInventoryWebhook = async function(inventory_item_id, available, updated_at) {
  // 1) Deduplicate exact retries within 5 minutes
  const dedupeKey = `${inventory_item_id}|${available}`;
  if (seenInventoryWebhooks.has(dedupeKey)) {
    console.log(`ðŸ” Skipping duplicate inventory webhook for item ${inventory_item_id}, Qty ${available}`);
    return;
  }
  seenInventoryWebhooks.add(dedupeKey);
  setTimeout(() => seenInventoryWebhooks.delete(dedupeKey), 5 * 60 * 1000);

  // 2) Staleness check: only process strictly newer timestamps
  const last = lastInventoryUpdate.get(inventory_item_id);
  if (last && new Date(updated_at) <= new Date(last.timestamp)) {
    console.log(`â®ï¸ Ignoring stale inventory webhook for item ${inventory_item_id} at ${updated_at}`);
    return;
  }
  // record this update
  lastInventoryUpdate.set(inventory_item_id, { available, timestamp: updated_at });

  // 3) Resolve Shopify product ID (parent) from inventory_item_id
  let shopifyProductId;
  try {
    shopifyProductId = await getShopifyProductIdFromInventoryItem(inventory_item_id);
  } catch (err) {
    console.error("âŒ Failed to fetch variant for inventory_item_id", inventory_item_id, err.message);
    return;
  }
  if (!shopifyProductId) {
    console.error("âŒ No Shopify product found for inventory_item_id", inventory_item_id);
    return;
  }
  shopifyProductId = String(shopifyProductId).trim();
  console.log(`ðŸ”„ InventoryLevel â†’ Shopify product ${shopifyProductId} available ${available}`);

  // 4) Skip looped updates if quantity unchanged
  if (lastUpdatedStock.get(shopifyProductId) === available) {
    console.log(`ðŸ” Skipping loop update for Shopify product ${shopifyProductId}, Qty ${available}`);
    return;
  }
  lastUpdatedStock.set(shopifyProductId, available);

  // 5) Finally, push into WooCommerce
  try {
    await updateWooCommerceInventory(shopifyProductId, available);
    console.log(`âœ… Woo stock updated for Shopify product ${shopifyProductId} â†’ ${available}`);
  } catch (err) {
    console.error("âŒ WooCommerce update failed:", err.response?.data || err.message);
  }
};
